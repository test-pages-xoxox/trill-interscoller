"use strict";var d2c,__extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),a=0;for(e=0;e<n;e++)for(var r=arguments[e],o=0,c=r.length;o<c;o++,a++)i[a]=r[o];return i};!function(t){!function(t){var e=function(){function t(t){this._isComplete=!1,this._next=t}return t.prototype.setNext=function(t){this._next=t},t.prototype.isComplete=function(){return this._isComplete},t.prototype.complete=function(t){var e;this._isComplete=!0,null===(e=this._next)||void 0===e||e.start(t)},t}();t.Task=e}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){var e=function(){return function(t,e,n,i){this.activityLogId=t,this.origin=e,this.domain=window.location.hostname,this.referrer=document.referrer,this.userAgent=window.navigator.userAgent,this.uach=n?JSON.parse(n):JSON.parse("{}"),this.nidanId=i}}(),n=function(n){function i(){return null!==n&&n.apply(this,arguments)||this}return __extends(i,n),i.prototype.createAccessLogData=function(t){var n=new e(t.activityLogId,t.requestOrigin,t.getUACHString(),t.nidanId);return JSON.stringify(n)},i.prototype.sendLog=function(e){var n=this.createAccessLogData(e);t.util.log("send log data : "+n),navigator.sendBeacon(e.getAccessLogURL(),n)},i.prototype.start=function(e){if(t.util.log("AccessLog task start"),e.compleatSendAccessLog)return t.util.log("already send AccessLog"),void this.complete(e);this.sendLog(e),this.complete(e)},i}(t.Task);t.AccessLogTask=n}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(e){var n;e.removers=t.nidan.removers||[],e.removeAllLogEvent=function(){for(;;){var t=e.removers.shift();if(!t)break;t()}};var i=function(){return function(t,e,n,i,a){this.logType=t,this.activityLogId=e,this.origin=n,this.domain=window.location.hostname,this.referrer=document.referrer,this.userAgent=window.navigator.userAgent,this.uach=i?JSON.parse(i):JSON.parse("{}"),this.startStayTime=Math.floor(a),this.sendTime=Math.floor(Date.now()/1e3),this.scrollY=Math.floor(window.scrollY),this.scrollHeight=Math.floor(document.body.scrollHeight),this.innerHeight=Math.floor(window.innerHeight),this.scrollX=Math.floor(window.scrollX),this.scrollWidth=Math.floor(document.body.scrollWidth),this.innerWidth=Math.floor(window.innerWidth)}}(),a=function(){function t(){}return t.prototype.createActivityLogData=function(t,e){var n=new i(e,t.activityLogId,t.requestOrigin,t.getUACHString(),t.loggingStart);return JSON.stringify(n)},t.prototype.isValidParameters=function(t){return"string"==typeof t&&""!==t},t.getActivityLogId=function(){if(t.activityLogId)return t.activityLogId;var n=e.util.getRandomString(20);return t.activityLogId=n,n},t.prototype.sendLog=function(t,n){var i=this.createActivityLogData(t,n);e.util.log("send log data : "+i),navigator.sendBeacon(t.getActivityLogURL(),i)},t.prototype.createLoggingFunction=function(t){var n=this;return function(i){if(n.isValidParameters(i)){var a=i;n.sendLog(t,a)}else e.util.log("parameter error:",i)}},t.activityLogId=null,t}();e.ActivityLogManager=a;var r=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return __extends(i,t),i.prototype.start=function(t){if(e.util.log("ActivityLog task start"),t.compleatActivity)return e.util.log("ActivityLog is already compleated"),void this.complete(t);var i=new a;t.loggingStart=Date.now()/1e3,t.activityLogId=a.getActivityLogId(),n=i.createLoggingFunction(t);var r=function(){"hidden"===document.visibilityState&&n("pageExit")};document.addEventListener("visibilitychange",r);e.removers.push(function(){document.removeEventListener("visibilitychange",r)}),e.util.log("status ActivityLogId: "+t.activityLogId),t.compleatActivity=!0,this.complete(t)},i}(e.Task);e.ActivityLogTask=r}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){var e=function(){function e(){this.uachString=null,this.uach=null,this.nidanId="",this.daisyId="",this.activityLogId="",this.loggingStart=0,this.completeDaisySync=!1,this.requestedDaisySync=!1,this.completeNidanSync=!1,this.completeUACH=!1,this.compleatActivity=!1,this.compleatSendAccessLog=!1,this.environment=new t.Environment,this.nidanDomain="",this.notifyCallbacksForNidanID=[],this.notifyCallbacksForNidanAndDadUID=[],this.requestOrigin="",this.nidanDomain=t.domain.replace("/",""),this.requestOrigin=window.location.origin}return e.prototype.getPreURL=function(){return this.environment.scheme+this.nidanDomain+this.environment.preRequestPath},e.prototype.getReceiverURL=function(){return this.environment.scheme+this.nidanDomain+this.environment.receiveRequestPath},e.prototype.getUACHString=function(){return null!==this.uachString?this.uachString:null===this.uach?(this.uachString="",this.uachString):(this.uachString=JSON.stringify(this.uach),this.uachString)},e.prototype.getActivityLogURL=function(){return this.environment.scheme+this.nidanDomain+this.environment.activityLogPath},e.prototype.getAccessLogURL=function(){return this.environment.scheme+this.nidanDomain+this.environment.accessLogPath},e}();t.NidanContext=e}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){var e=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return __extends(n,e),n.prototype.start=function(e){for(t.util.log("EventStart");e.notifyCallbacksForNidanAndDadUID.length>0;){e.notifyCallbacksForNidanAndDadUID.pop()(e.nidanId,e.daisyId)}t.util.log("EventStart"),this.complete(e)},n}(t.Task);t.DadUIDNotifyTask=e}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(e){var n=function(n){function i(){return null!==n&&n.apply(this,arguments)||this}return __extends(i,n),i.prototype.start=function(t){e.util.log("request start DadUIDSync");var n=e.util.getRandomString(10);this.setReceiverFunc(t,n),this.addRequest(t,n),e.util.log("DadUIDSync append child"),e.util.log("request end DadUIDSync")},i.prototype.addRequest=function(t,e){var n=document.createElement("script"),i=new URL(t.environment.dadSyncURL);i.searchParams.append("callback",'d2c.nidan.receivers["'+e+'"]'),i.searchParams.append("origin",t.requestOrigin),i.searchParams.append("domain",window.location.hostname),i.searchParams.append("activityLogId",t.activityLogId),i.searchParams.append("referrer",document.referrer),i.searchParams.append("userAgent",window.navigator.userAgent),i.searchParams.append("uach",t.getUACHString()),n.src=i.toString(),document.head.appendChild(n)},i.prototype.setReceiverFunc=function(n,i){var a=this;t.nidan.receivers[i]=function(t){e.util.log("response DadUIDSync start"),t&&(n.daisyId=t),n.completeDaisySync=!0,a.complete(n),e.util.log("response DadUIDSync end")}},i}(e.Task);e.DadUIDSyncTask=n}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){var e=function(){function e(){this._scheme="https:",this._preRequestPath="/id/nidan/pre",this._receiveRequestPath="/id/nidan/receiver",this._activityLogPath="/activity",this._accessLogPath="/access",this._storageKey="__nidan_id",this._paramKey="__did__",this._dadSyncUrl="https://nidan.addlv.smt.docomo.ne.jp/id/daisy/sync",this._nidanIDRequiredLength=80;var e=window;if(e._d2c_nidan_option&&"object"==typeof e._d2c_nidan_option){var n=e._d2c_nidan_option,i=n.scheme;i&&("https:"!==i&&"http:"!==i||(this._scheme=i));var a=n.preRequestPath;a&&(this._preRequestPath=a);var r=n.storageKey;r&&(this._storageKey=r);var o=n.dadSyncUrl;o&&(this._dadSyncUrl=o),t.util.log(this)}}return Object.defineProperty(e.prototype,"scheme",{get:function(){return this._scheme+"//"},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"preRequestPath",{get:function(){return this._preRequestPath},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"receiveRequestPath",{get:function(){return this._receiveRequestPath},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activityLogPath",{get:function(){return this._activityLogPath},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"accessLogPath",{get:function(){return this._accessLogPath},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"storageKey",{get:function(){return this._storageKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"paramKey",{get:function(){return this._paramKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dadSyncURL",{get:function(){return this._dadSyncUrl},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"nidanIDRequiredLength",{get:function(){return this._nidanIDRequiredLength},enumerable:!1,configurable:!0}),e}();t.Environment=e}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(e){var n=function(n){function i(){return null!==n&&n.apply(this,arguments)||this}return __extends(i,n),i.prototype.start=function(t){var n=this.getNidanId(t);if(""!==n){for(t.nidanId=n,t.completeNidanSync=!0;t.notifyCallbacksForNidanID.length>0;){t.notifyCallbacksForNidanID.pop()(t.nidanId,t.daisyId)}this.complete(t)}else{e.util.log("NidanPre Append"),t.compleatSendAccessLog=!0;var i=e.util.getRandomString(10);this.setReceiverFunc(t,i),this.addPreRequest(t,i)}},i.prototype.addPreRequest=function(t,e){this.addRequest(t.getPreURL(),t,e)},i.prototype.addReceiverRequest=function(t,e){this.addRequest(t.getReceiverURL(),t,e)},i.prototype.addRequest=function(t,e,n){var i=document.createElement("script"),a=new URL(t);a.searchParams.append("callback",'d2c.nidan.receivers["'+n+'"]'),a.searchParams.append("nocache",(new Date).getTime().toString()),a.searchParams.append("origin",e.requestOrigin),a.searchParams.append("domain",window.location.hostname),a.searchParams.append("activityLogId",e.activityLogId),a.searchParams.append("referrer",document.referrer),a.searchParams.append("userAgent",window.navigator.userAgent),a.searchParams.append("uach",e.getUACHString()),""!==e.nidanId&&a.searchParams.append("nidanid",e.nidanId),i.src=a.toString(),document.head.appendChild(i)},i.prototype.setReceiverFunc=function(n,i){var a=this;t.nidan.receivers[i]=function(t){for(e.util.log("Nidan Pre Receiver Start"),t&&""!==t&&(n.nidanId=t,localStorage.setItem(n.environment.storageKey,t)),n.completeNidanSync=!0;n.notifyCallbacksForNidanID.length>0;){n.notifyCallbacksForNidanID.pop()(n.nidanId,n.daisyId)}a.complete(n),a.publicationCookieDeleteRequest(n)}},i.prototype.publicationCookieDeleteRequest=function(n){var i=e.util.getRandomString(10);t.nidan.receivers[i]=function(){e.util.log("delete request receive")},this.addReceiverRequest(n,i)},i.prototype.getNidanId=function(t){var e="",n=localStorage.getItem(t.environment.storageKey);"string"==typeof n&&""!==n&&(e=n);var i=window.location.search;if(0===i.length)return e;var a=[];return i.slice(1).split("&").forEach(function(e){var n=e.split("=");2===n.length&&n[0]===t.environment.paramKey&&""!==n[1]&&a.push(n[1])}),1===a.length?(e!==a[0]&&localStorage.setItem(t.environment.storageKey,a[0]),a[0]):e},i}(e.Task);e.NidanSyncTask=n}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){!function(t){t.getRandomString=function(t){for(var e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",n=e.length,i="",a=0;a<t;a++)i+=e[Math.floor(Math.random()*n)];return i},t.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e]}}(t.util||(t.util={}))}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){var e=function(){function e(){}return e.getUserAgentClientHintInfo=function(){try{return e.getNavigator().userAgentData.getHighEntropyValues(e.HIGH_ENTROPY_VALUE_KEYS)}catch(e){return t.util.log("getUserAgentClientHintInfo something error"),t.util.log(e),null}},e.getNavigator=function(){return navigator},e.HIGH_ENTROPY_VALUE_KEYS=["platform","platformVersion","architecture","model","fullVersionList"],e}(),n=function(n){function i(){return null!==n&&n.apply(this,arguments)||this}return __extends(i,n),i.prototype.start=function(n){var i=this;if(t.util.log("UACH Task start"),n.completeUACH)return t.util.log("UACH Task already finished"),void this.complete(n);var a=e.getUserAgentClientHintInfo();a?a.then(function(e){n.uach=e,t.util.log("UACH Task end:success")}).catch(function(){n.uach=null,t.util.log("UACH Task end:catch")}).finally(function(){n.completeUACH=!0,t.util.log("UACH Task complete"),i.complete(n)}):(n.uach=null,n.completeUACH=!0,t.util.log("UACH Task end:else"),this.complete(n))},i}(t.Task);t.UACHTask=n}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(e){var n=function(){function n(){this.context=new e.NidanContext,e.util.log("satrt id manager");var n=localStorage.getItem(this.context.environment.storageKey),i=new RegExp("^([a-z]|[A-Z]|[0-9]){80}$");if(n&&!i.test(n)&&(e.util.log("browser has invalid acid"),localStorage.removeItem(this.context.environment.storageKey)),t.nidan.receivers||(t.nidan.receivers={}),"string"!=typeof e.domain||""===e.domain)throw new Error("domain required");var a=new e.UACHTask,r=new e.ActivityLogTask,o=new e.NidanSyncTask,c=new e.AccessLogTask;a.setNext(r),r.setNext(o),o.setNext(c),a.start(this.context),e.util.log("satrt id manager")}return n.getInstance=function(){return e.manager||(e.manager=new n)},n.prototype.getNidanID=function(t){if(e.util.log("Called:getNidanId"),"function"!=typeof t)throw new Error("callback func require");this.context.completeNidanSync?t(this.context.nidanId):(this.context.notifyCallbacksForNidanID.push(t),e.util.log("キュー数："+this.context.notifyCallbacksForNidanID.length))},n.prototype.getNidanAndDadUID=function(t){var n=this;if("function"!=typeof t)throw new Error("callback func require");if(this.context.completeNidanSync&&this.context.completeDaisySync)return e.util.log("Before Completed. notify callback."),void t(this.context.nidanId,this.context.daisyId);if(this.context.notifyCallbacksForNidanAndDadUID.push(t),e.util.log("Add Queue for NidanAndDadUID. length:"+this.context.notifyCallbacksForNidanAndDadUID.length),!this.context.requestedDaisySync){this.context.requestedDaisySync=!0,e.util.log("Daisy Sync Request Start");var i=new e.DadUIDSyncTask,a=new e.WaitTask;i.setNext(a);var r=new e.DadUIDNotifyTask;a.setNext(r),this.getNidanID(function(t){a.start(n.context)});var o=new e.UACHTask,c=new e.ActivityLogTask;o.setNext(c),c.setNext(i),o.start(this.context)}},n}();e.NidanIdManager=n}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.start=function(t){t.completeNidanSync&&t.completeDaisySync&&this.complete(t)},e}(t.Task);t.WaitTask=e}(t.nidan||(t.nidan={}))}(d2c||(d2c={})),function(t){!function(e){e.getId=function(t){e.NidanIdManager.getInstance().getNidanID(t)},e.getIds=function(t){e.NidanIdManager.getInstance().getNidanAndDadUID(t)},setTimeout(function(){for(var n=e.NidanIdManager.getInstance(),i=t.nidan.tasks||new Array;i.length>0;)n.getNidanID(i.shift())})}(t.nidan||(t.nidan={}))}(d2c||(d2c={}));